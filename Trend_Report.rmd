---
title: "Epi Trends Report"
subtitle: '`r format(params$date,"%B %d, %Y")`'
output: 
  powerpoint_presentation:
    reference_doc: src/template.pptx
params:
  date: !r Sys.Date()
  report: trend
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load libraries
library(reticulate)
library(knitr)
library(readr)
library(tidyr)
library(dplyr)
library(patchwork)
library(scales)
library(zoo)
library(lubridate)
library(readxl)
library(gridExtra)
library(ggrepel)
library(ggthemes)
library(cansim)
library(janitor)
library(xml2)
library(rvest)
library(stringr)
library(flextable)
library(officer)
library(hms)
library(googlesheets4)
library(metabaser) #need to run: devtools::install_github("PHACDataHub/metabaser") to install this package for the first time (https://github.com/PHACDataHub/metabaser for more info)
library(PHACTrendR) #need to run: devtools::install_github("Michael-Elten/PHACTrendR") to install this package for the first time
library(rvg)
library(officedown)
# library(cachem)

two_weeks_ago <- params$date - weeks(2)

#Boolean value that returns TRUE when the report param is "trend" - allows for selective running of trend vs Chief Science report
eval_if_trend<-(params$report=="trend")

day_of_week<-weekdays(Sys.Date())

normal_day<-(day_of_week %in% c("Sunday","Tuesday","Wednesday"))
monday<-(day_of_week=="Monday")
thursday<-(day_of_week=="Thursday")
```

# COVID-19 Cases and Deaths Summary Statistics

```{r Cases and Death Table Part 1, code=xfun::read_utf8('src/Cases Death Table.R'), results='asis', message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r Cases and Death Table Part 2, message=FALSE, warning=FALSE}
casedeath_table<-format_casedeath_table(input_table=Case_Death_Stats)
casedeath_table
```

```{r use_condaenv, results='asis', message=FALSE, warning=FALSE}
use_condaenv("r-reticulate")
```

```{python import_os_tarfile_urllib_packages, results='asis', message=FALSE, warning=FALSE}
import os
import getpass
user=getpass.getuser()
os.environ['QT_QPA_PLATFORM_PLUGIN_PATH'] = 'C:/Users/'+user+'/AppData/Local/r-miniconda/envs/r-reticulate/Library/plugins/platforms'
```



<!--  ```{r Case rate figure using rmd, child="src/case_per_100k.Rmd",eval=eval_if_trend, echo=FALSE, message=FALSE, warning=FALSE,reticulate.repl.quiet = TRUE} -->
<!--  ``` -->

# Daily COVID-19 Cases by Date of Report, Canada

```{r case rate figure using R, code=xfun::read_utf8('src/case_per_100k.R'), results='asis', message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

<!-- ```{r Insert Canada case per 100K figure, echo=FALSE, results = 'asis', message=FALSE, warning=FALSE, out.width='100%'} -->
<!--  fig.cap=paste(key_100k_caption) #insert this if want figure caption to text (still working this out so going back to python caption) -->
<!-- knitr::include_graphics("output/Canada_case_per_100k.png") -->
<!--  ``` -->

```{r Case and death slides per province, code=xfun::read_utf8('src/01_cd_slides.R'), results='asis', message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# Daily cases by Jurisdiction (7-day moving average)

```{r Case rates for big 6, code=xfun::read_utf8('src/03_pt_slides.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r Hospitalization header, echo=FALSE, results='asis', eval=eval_if_trend}
cat(
"# COVID-19 Hospitalizations and ICU Statistics")
```

```{r Hospitalization ICU Metrics Table, echo=FALSE, message=FALSE, warning=FALSE, results='asis',eval=eval_if_trend}
source("src/05a_hosp_table.R")
hospicu_table<-format_hospicu_table(input_table=Hosp_Metrics_Table)
hospicu_table
```

```{r Crude HospICU graphs, code=xfun::read_utf8('src/05b_hosp_graphs.R'), results = "asis", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# COVID-19 patients in hospital daily per 100,000 population

```{r hospitalizations per 100k figure, code=xfun::read_utf8('src/05c_hosp_per.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r Epi indicators header, echo=FALSE, results='asis', eval=eval_if_trend}
cat(
"# Epi Indicators

Indicators derived from the Case Report Forms")
```

# COVID-19 cases by age (crude), Canada
```{r Canada Crude C, code=c(Sys.setenv(age_prname="Canada"), xfun::read_utf8('src/04a_crude_can_age.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# COVID-19 cases by age (population-adjusted), Canada
```{r Canada Age C, code=c(Sys.setenv(age_prname="Canada"), xfun::read_utf8('src/04b_age_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# COVID-19 cases by age (population-adjusted), select PTs
```{r PT Age C, code=c(Sys.setenv(age_prname="pts"), xfun::read_utf8('src/04b_age_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r hosp and death by age, code=xfun::read_utf8('src/04c_severity_by_age.R'),  results = "asis", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20, eval=eval_if_trend}
```

```{r Laboratory indicators header, echo=FALSE, results='asis', eval=eval_if_trend}
cat(
"# Laboratory Indicators")
```

```{r Lab Testing Metrics, code=xfun::read_utf8('src/06_labtesting_weekly.R'), eval=eval_if_trend, results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r Lab Testing Table, message=FALSE, warning=FALSE, eval=eval_if_trend}
labtesting_table<-format_labtesting_table(input_table=Testing_Metrics)
labtesting_table
```

```{r Laboratory table text, echo=FALSE, message=FALSE, warning=FALSE,results='asis', eval=eval_if_trend}
cat(
paste0("Highlights:
Over the past week, a daily average of ",key_Can_avg_tests_per_day," tests have been performed for COVID-19 across Canada, for a total of ",key_Can_weekly_tests," tests. The weekly percent positivity is ",key_Can_weekly_perc_positive))
```

<!-- ```{r lab_testing figure using rmd, child="src/national_testing.rmd",eval=eval_if_trend, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- ``` -->


<!-- ```{r National Testing Graphic, fig.cap=(key_lab_figure_footnote),echo=FALSE, out.width='100%', eval=eval_if_trend} -->
<!-- knitr::include_graphics("output/Testing_National.png") -->
<!-- ``` -->

```{r lab testing figure with R, code=xfun::read_utf8('src/national_testing.R'), fig.cap=(key_lab_figure_footnote), results='asis', message=FALSE, warning=FALSE, , eval=eval_if_trend, fig.height = 9, fig.width = 20}
```

```{r International indicators header, echo=FALSE, results='asis', eval=eval_if_trend}
cat(
"# International Indicators

Indicators derived from International Sources")
```

```{r Int C, code=xfun::read_utf8('src/02_int_slides.R'), results = "asis", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20, eval=eval_if_trend}
```

```{r generate_summary_bullets, echo=FALSE ,eval=eval_if_trend}
source("src/summary_bullets.R")
```

```{r print_summary_bullets_normal_day, child="src/summary_bullets.Rmd",eval=eval_if_trend&normal_day}
```
```{r print_summary_bullets_monday, child="src/summary_bullets_monday.Rmd",eval=eval_if_trend&monday}
```
```{r print_summary_bullets_thursday, child="src/summary_bullets_thursday.Rmd",eval=eval_if_trend&thursday}
```

```{r CPHO Table, echo=FALSE, results='asis', eval=eval_if_trend}
source("src/CPHO_table.R")
```