---
title: "Epi Trends Report"
subtitle: '`r params$date`'
output: 
  powerpoint_presentation:
    reference_doc: src/template.pptx
params:
  date: !r Sys.Date()
  region:
    label: "Select which P/Ts to include in report"
    value: Major provinces
    input: select
    choices: [All P/Ts, Major provinces]        
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Import data from network drive using Python
library(reticulate)
source_python("src/00_get_data.py")

# Load libraries
library(readr)
library(tidyverse)
library(patchwork)
library(scales)
library(zoo)
library(lubridate)
library(readxl)
library(gridExtra)
library(ggrepel)
library(ggthemes)
library(cansim)
library(janitor)
library(xml2)
library(rvest)
library(stringr)
library(flextable)
library(officer)
library(hms)

# Import data
source("src/00_get_data.R")

list_pt <-  if (params$region == "Major provinces") {
  c("Canada",
    "British Columbia",
    "Alberta",
    "Saskatchewan",
    "Manitoba",
    "Ontario",
    "Quebec")
} else {
  c("Canada",
    "British Columbia",
    "Alberta",
    "Saskatchewan",
    "Manitoba",
    "Ontario",
    "Quebec",
    "New Brunswick",
    "Prince Edward Island",
    "Nova Scotia",
    "Newfoundland and Labrador",
    "Northwest Territories",
    "Nunavut",
    "Yukon")
}
two_weeks_ago <- params$date - weeks(2)
```

# Summary

- Bullet 1
- Bullet 2
- Bullet 3

# COVID-19 Cases and Deaths Summary Statistics

```{r Cases and Death Table Part 1, code=xfun::read_utf8('src/Cases Death Table.R'), results='asis', message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r Cases and Death Table Part 2, message=FALSE, warning=FALSE}
ft <- flextable(Case_Death_Stats)
ft <- color(ft, j = "Weekly_Change_Cases", i = ~ Weekly_Change_Cases > 0, color="red")
ft <- color(ft, j = "Weekly_Change_Cases", i = ~ Weekly_Change_Cases < 0, color="dark green")
ft <- color(ft, j = "Weekly_Change_Deaths", i = ~ Weekly_Change_Deaths > 0, color="red")
ft <- color(ft, j = "Weekly_Change_Deaths", i = ~ Weekly_Change_Deaths < 0, color="dark green")
ft <- set_header_labels(ft, Cases_Daily="Daily Cases", Cases_Daily_7MA="7 Day MA, Cases",Cases_7MA_per100k="7 Day cases MA per 100,000",Weekly_Change_Cases="Weekly Change in Cases",National_Case_Proportion="National Proportion of Cases",Deaths_Daily="Daily Deaths",Deaths_Daily_7MA="7 Day MA, Deaths",Deaths_7MA_per100k="7 Day deaths MA per 100,000",Weekly_Change_Deaths="Weekly Change in Deaths",National_Death_Proportion="National Proportion of Deaths")
#ft <- width(ft, width=1.2)
ft <- height(ft, height=.52, part = "header")
ft <- height(ft, height=.26, part = "body")
ft <- fontsize(ft, size = 11, part="all")
#ft <- fontsize(ft, size = 12, part="body")
ft <- align(ft, align = "center", part="all")
#Fill colours - first two columns in green
ft<-bg(ft,j=1:2, bg="#9bbb59", part="header")
ft<-bg(ft,i=seq(1,nrow(ft$body$dataset),2),j=1:2, bg="#d7e4bd")
ft<-bg(ft,i=seq(2,nrow(ft$body$dataset),2),j=1:2, bg="#ebf1de")
#columns 3-7 in blue
ft<-bg(ft,j=3:7, bg="#17375e", part="header")
ft<-bg(ft,i=seq(1,nrow(ft$body$dataset),2),j=3:7, bg="#b9cde5")
ft<-bg(ft,i=seq(2,nrow(ft$body$dataset),2),j=3:7, bg="#dce6f2")
#columns 8-12 in grey
ft<-bg(ft,j=8:12, bg="#7f7f7f", part="header")
ft<-bg(ft,i=seq(1,nrow(ft$body$dataset),2),j=8:12, bg="#d9d9d9")
ft<-bg(ft,i=seq(2,nrow(ft$body$dataset),2),j=8:12, bg="#f2f2f2")
#Header colour to white
ft<-color(ft,color="white",part="header")
big_border = fp_border(color="white", width=2)
border_v = fp_border(color="white")
border_h = fp_border(color="white")
ft <- border_outer(ft, part = "all", border = big_border)
ft <- border_inner_v(ft, part = "all", border = border_v)
ft <- border_inner_h(ft, part = "all", border = border_h)

ft_1 <- ft %>% footnote(., i=1, j=6, value = as_paragraph(
              c("Weekly change is how the current week (days 1 to 7 days ago) compares against the previous week (8 to 14 days ago).  e.g. previous week = 75 total cases; current week = 50 total cases; weekly percent change from previous week to current week = 33.3% decrease (-33.3%)."#,
                #"Source: Provincial and territorial website data")
            )),
            ref_symbols = c("*"),
            part = "header") %>%
        footnote(., i=1, j=11, value = as_paragraph(
              c("Weekly change is how the current week (days 1 to 7 days ago) compares against the previous week (8 to 14 days ago).  e.g. previous week = 75 total cases; current week = 50 total cases; weekly percent change from previous week to current week = 33.3% decrease (-33.3%)."#,
                #"Source: Provincial and territorial website data")
            )),
            ref_symbols = c("*"),
            part = "header") %>% merge_v(part="footer") %>%

        footnote(., value = as_paragraph(
              c("Source: Provincial and territorial website data. ")
            ),
            ref_symbols = c(""),
            part = "header") %>%
  
        footnote(., value = as_paragraph(
              paste0("Updated daily (Sun-Thurs). Last updated: ", 
                Case_Death_Stats %>% filter(Date==max(Date), Jurisdiction=="Canada") %>% select(Date) %>% unique() %>% pull()
        )),
            ref_symbols = c(""),
            part = "header")

#ft_1 <- autofit(ft_1)

ft_1
```


# Daily COVID-19 Cases by Date of Report, Canada

```{r use_condaenv, results='asis', message=FALSE, warning=FALSE}
use_condaenv("r-reticulate")
```


```{python import_os_tarfile_urllib_packages, results='asis', message=FALSE, warning=FALSE}
import os
import getpass
user=getpass.getuser()
os.environ['QT_QPA_PLATFORM_PLUGIN_PATH'] = 'C:/Users/'+user+'/AppData/Local/r-miniconda/envs/r-reticulate/Library/plugins/platforms'
```

```{r Python Codes for Graphics, results='asis', message=FALSE, warning=FALSE}
source_python("src/case_per_100k.py")
source_python("src/National_Testing.py")
```

```{r Insert Canada case per 100K, echo=FALSE, results = 'asis', message=FALSE, warning=FALSE, out.width='100%'}
knitr::include_graphics('Canada_case_per_100k.jpg')
```

::: notes
Source: Provincial and territorial website data
:::

```{r CD, code=xfun::read_utf8('src/01_cd_slides.R'), results='asis', message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# Daily cases by Jurisdiction (7-day moving average)

```{r PT C, code=xfun::read_utf8('src/03_pt_slides.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# COVID-19 Hospitalizations and ICU Statistics

```{r Hospitalization ICU Metrics Table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}

source("src/05a_hosp_table.R")

ft <- flextable(Hosp_Metrics_Table)
ft <- color(ft, j = "delta7h", i = ~ delta7h > 0, color="red")
ft <- color(ft, j = "delta7h", i = ~ delta7h < 0, color="dark green")
ft <- color(ft, j = "delta7i", i = ~ delta7i > 0, color="red")
ft <- color(ft, j = "delta7i", i = ~ delta7i < 0, color="dark green")
ft <- set_header_labels(ft, hosp7ma="Hospitalizations, 7 Day MA", delta7h="Weekly Change in Hospitalizations",icu7ma="ICU, 7 Day MA",delta7i="Weekly Change in ICU")
#ft <- width(ft, width=1.2)
ft <- height(ft, height=.39, part="header")
ft <- height(ft, height=.26, part="body")
ft <- fontsize(ft, size = 12, part="all")
ft <- align(ft, align = "center", part="all")

#shading headers, and alternating rows.
ft<-bg(ft, bg="#4f81bd", part="header")
ft<-bg(ft,i=seq(1,nrow(ft$body$dataset),2), bg="#d0d8e8")
ft<-bg(ft,i=seq(2,nrow(ft$body$dataset),2), bg="#e8edf4")
ft<-color(ft,color="white",part="header")

big_border = fp_border(color="black", width=2)
border_v = fp_border(color="black")
border_h = fp_border(color="black")

ft <- border_outer(ft, part = "all", border = big_border)
ft <- border_inner_v(ft, part = "all", border = border_v)
ft <- border_inner_h(ft, part = "all", border = border_h)
ft <- autofit(ft)

ft_1 <- footnote( ft, value = as_paragraph(
              c("Source: Provincial and territorial website data. ")
            ),
            ref_symbols = c("")) %>%
        footnote(., value = as_paragraph(
                    paste0("Updated every Sun/Tues/Thurs. Last updated: ", 
                      Hosp_Metrics_Table %>% filter(Date==max(Date), Jurisdiction=="Canada") %>% select(Date) %>% unique() %>% pull()
              )),
                  ref_symbols = c(""),
                  part = "header")
            
#ft_1 <- autofit(ft_1)

ft_1
```


```{r HospICU, code=xfun::read_utf8('src/05b_hosp_graphs.R'), results = "asis", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```


# COVID-19 patients in hospital daily per 100,000 population 

```{r, code=xfun::read_utf8('src/05c_hosp_per.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# Epi Indicators

Indicators derived from the Case Report Forms

# COVID-19 cases by age (crude), Canada
```{r Canada Crude C, code=c(Sys.setenv(age_prname="Canada"), xfun::read_utf8('src/04a_crude_can_age.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# COVID-19 cases by age (population-adjusted), Canada
```{r Canada Age C, code=c(Sys.setenv(age_prname="Canada"), xfun::read_utf8('src/04_age_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# COVID-19 cases by age, select provinces and territories
```{r PT Age C, code=c(Sys.setenv(age_prname="pts"), xfun::read_utf8('src/04_age_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

# Laboratory Indicators

```{r Lab Testing Metrics, code=xfun::read_utf8('src/06_labtesting_weekly.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

```{r Lab Testing Table, message=FALSE, warning=FALSE}
ft <- flextable(Testing_Metrics)
ft <- width(ft, width=1.2)
ft <- height_all(ft, height=.26)
ft <- fontsize(ft, size = 14, part="header")
ft <- fontsize(ft, size = 12, part="body")
ft <- align(ft, align = "center", part="all")

big_border = fp_border(color="black", width=2)
border_v = fp_border(color="black")
border_h = fp_border(color="black")

ft <- border_outer(ft, part = "all", border = big_border)
ft <- border_inner_v(ft, part = "all", border = border_v)
ft <- border_inner_h(ft, part = "all", border = border_h)

#shading headers, and alternating rows.
ft<-bg(ft, bg="#4f81bd", part="header")
ft<-bg(ft,i=seq(1,nrow(ft$body$dataset),2), bg="#d0d8e8")
ft<-bg(ft,i=seq(2,nrow(ft$body$dataset),2), bg="#e8edf4")
ft<-color(ft,color="white",part="header")

#add conditional colour to change in testing variable
ft <- color(ft, j = "Change from week before", i = ~ `Change from week before` < 0, color="red")
ft <- color(ft, j = "Change from week before", i = ~ `Change from week before` > 0, color="dark green")

ft_1 <- footnote(ft, value = as_paragraph(c("* On January 15, 2021, Alberta provided cumulative testing data for December 11, 2020 to January 15, 2021. Values for Canada exclude Alberta as disaggregation by week was not possible with AB data provided")),
                ref_symbols = c("")) %>%
  
        footnote(., value = as_paragraph(
                    paste0("Updated every Sun/Tues/Thurs. Last updated: ", 
                    SALT4 %>% filter(Date==max(Date)) %>% select(Date) %>% unique() %>% pull() %>% max()
              )),
                  ref_symbols = c(""),
                  part = "header")      
ft_1
```
Highlights:
Over the past week, a daily average of 77,858 people have been tested for COVID-19 across Canada* with a total of 545,003 tested in the recent week. The weekly percent positivity is 8.1%.

```{r National Testing Graphic, echo=FALSE, out.width='100%'}
knitr::include_graphics('National_Testing.jpg')
```

::: notes
* On January 15, 2021, Alberta provided cumulative testing data for December 11, 2020 to January 15, 2021. Values for Canada exclude Alberta as disaggregation by week was not possible with AB data provided
:::

# International Indicators

Indicators derived from International Sources

```{r Int C, code=xfun::read_utf8('src/02_int_slides.R'), results = "asis", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```
