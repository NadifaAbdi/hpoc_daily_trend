---
title: "Epi Trends Report"
subtitle: '`r params$date`'
output: 
  powerpoint_presentation:
    reference_doc: src/template.pptx
params:
  date: !r Sys.Date()
  region:
    label: "Select which P/Ts to include in report"
    value: Major provinces
    input: select
    choices: [All P/Ts, Major provinces]        
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Import data from network drive using Python
library(reticulate)
source_python("src/00_get_data.py")

# Load libraries
library(tidyverse)
library(patchwork)
library(scales)
library(zoo)
library(lubridate)
library(gridExtra)
library(ggrepel)
library(ggthemes)
library(cansim)
library(janitor)
library(xml2)
library(rvest)
library(stringr)

# Import data
source("src/00_get_data.R")

list_pt <- if (params$region == "Major provinces") c("Canada", "British Columbia","Alberta", "Saskatchewan", "Manitoba",
                                                     "Ontario", "Quebec") else 
                                                             c("Canada", "British Columbia","Alberta", "Saskatchewan", "Manitoba",
                                                     "Ontario", "Quebec", "New Brunswick", "Prince Edward Island", "Nova Scotia", 
                                                     "Newfoundland and Labrador", "Northwest Territories", "Nunavut", "Yukon")
two_weeks_ago <- params$date - weeks(2)
```

## Summary

- Bullet 1
- Bullet 2
- Bullet 3

```{r, results='asis', message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
for (i in list_pt){
   cat('\n')  
   cat("##", i, "COVID-19 Indicators (Cases and Deaths)", "\n") 

df_filter <- df %>%
    filter(prname == i) %>%
    filter(date >= "2020-03-08")

table_filter_case <- data.frame(
    desc = c(paste0("Reported on ", params$date), "7-day moving average (per day):", "Weekly percent change"),
    value = c(
        df_filter %>% filter(date == max(date)) %>% select(numtoday) %>% pull(),
        df_filter %>% filter(date >= max(date) - days(6)) %>% summarise(average = mean(numtoday, na.rm = T)) %>% pull(),
        df_filter %>% mutate(sdma = rollmean(numtoday, 7, na.pad = TRUE, align = "right")) %>%
            mutate(wow = (sdma - lag(sdma, 7)) / lag(sdma, 7)) %>%
            filter(date == max(date)) %>%
            select(wow) %>%
            pull()
    )
) %>% mutate_if(is.numeric, round, digits = 2)

table_filter_death <- data.frame(
    desc = c(paste0("Reported on ", params$date), "7-day moving average (per day):", "Weekly percent change"),
    value = c(
        df_filter %>% filter(date == max(date)) %>% select(numdeathstoday) %>% pull(),
        df_filter %>% filter(date >= max(date) - days(6)) %>% summarise(average = mean(numdeathstoday, na.rm = T)) %>% pull(),
        df_filter %>% mutate(sdma = rollmean(numdeathstoday, 7, na.pad = TRUE, align = "right")) %>%
            mutate(wow = (sdma - lag(sdma, 7)) / lag(sdma, 7)) %>%
            filter(date == max(date)) %>%
            select(wow) %>%
            pull()
    )
) %>% mutate_if(is.numeric, round, digits = 2)

# Code for conditional colouring of the text in the code
cols_case <- matrix("black", nrow(table_filter_case), ncol(table_filter_case))
cols_case[3, 2] <- if_else(table_filter_case[3, 2] > 0, "red",
    if_else(table_filter_case[3, 2] < 0, "green", "black")
)

cols_death <- matrix("black", nrow(table_filter_death), ncol(table_filter_death))
cols_death[3, 2] <- if_else(table_filter_death[3, 2] > 0, "red",
    if_else(table_filter_death[3, 2] < 0, "green", "black")
)

# Charting the plots
p1 <- ggplot(df_filter, aes(x = date, y = numtoday)) +
    ggtitle(paste0("Reported COVID19 cases by date, ", i)) +
    geom_col(aes(fill = "Reported cases"), width = 0.5) +
    geom_line(aes(
        colour = "7 day moving average (7MA)",
        y = rollmean(numtoday, 7, na.pad = TRUE, align = "right")
    )) +
    scale_x_date(
        NULL,
        breaks = scales::breaks_width("3 weeks"),
        labels = label_date("%d%b"),
        expand = c(0, 0)
    ) +
    scale_y_continuous(
        "Number of cases",
        labels = comma,
        expand = c(0, 0)
    ) +
    scale_fill_manual(name = "", values = c("Reported cases" = "lightblue")) +
    scale_colour_manual(name = "", values = c("7 day moving average (7MA)" = "blue")) +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom",
        text = element_text(size = 20)
    )

p2 <- ggplot(df_filter, aes(x = date, y = numdeathstoday)) +
    ggtitle(paste0("Reported COVID19 deaths by date, ", i)) +
    geom_col(aes(fill = "Reported deaths"), width = 0.5) +
    geom_line(aes(
        colour = "7 day moving average (7MA)",
        y = rollmean(numdeathstoday, 7, na.pad = TRUE, align = "right")
    )) +
    scale_x_date(
        NULL,
        breaks = scales::breaks_width("3 weeks"),
        labels = label_date("%d%b"),
        expand = c(0, 0)
    ) +
    scale_y_continuous(
        "Number of deaths",
        labels = comma,
        expand = c(0, 0)
    ) +
    scale_fill_manual(name = "", values = c("Reported deaths" = "grey")) +
    scale_colour_manual(name = "", values = c("7 day moving average (7MA)" = "black")) +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom",
        text = element_text(size = 20)
    )

p3 <- ggplot(df_filter, aes(x = date, y = numtoday)) +
    ggtitle(paste0("Daily cases, past 2 weeks, ", i)) +
    geom_col(aes(fill = "Reported cases"), width = 0.5) +
    geom_line(aes(
        colour = "7 day moving average (7MA)",
        y = rollmean(numtoday, 7, na.pad = TRUE, align = "right")
    )) +
    scale_x_date(
        NULL,
        breaks = scales::breaks_width("5 days"),
        labels = label_date("%d%b"),
        limits = c(
            df_filter %>% filter(date == max(date)) %>% select(date) %>% pull() - weeks(2),
            df_filter %>% filter(date == max(date)) %>% select(date) %>% pull() + 1
        ),
        expand = c(0, 0)
    ) +
    scale_y_continuous(
        "Number of cases",
        labels = comma,
        limits = c(0, df_filter %>%
            filter(date >= max(date) - weeks(2)) %>%
            select(numtoday) %>% max()),
        expand = c(0, 0)
    ) +
    scale_fill_manual(name = "", values = c("Reported cases" = "lightblue")) +
    scale_colour_manual(name = "", values = c("7 day moving average (7MA)" = "blue")) +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom",
        text = element_text(size = 20)
    )

p4 <- ggplot(df_filter, aes(x = date, y = numdeathstoday)) +
    ggtitle(paste0("Daily deaths, past 2 weeks, ", i)) +
    geom_col(aes(fill = "Reported deaths"), width = 0.5) +
    geom_line(aes(
        colour = "7 day moving average (7MA)",
        y = rollmean(numdeathstoday, 7, na.pad = TRUE, align = "right")
    )) +
    scale_x_date(
        NULL,
        breaks = scales::breaks_width("5 days"),
        labels = label_date("%d%b"),
        limits = c(
            df_filter %>% filter(date == max(date)) %>% select(date) %>% pull() - weeks(2),
            df_filter %>% filter(date == max(date)) %>% select(date) %>% pull() + 1
        ),
        expand = c(0, 0)
    ) +
    scale_y_continuous(
        "Number of cases",
        labels = comma,
        limits = c(0, df_filter %>%
            filter(date >= max(date) - weeks(2)) %>%
            select(numdeathstoday) %>% max()),
        expand = c(0, 0)
    ) +
    scale_fill_manual(name = "", values = c("Reported deaths" = "grey")) +
    scale_colour_manual(name = "", values = c("7 day moving average (7MA)" = "black")) +
    theme(
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        legend.position = "bottom",
        text = element_text(size = 20)
    )

# Set the layout of the plots and tables in Patchwork syntax
output <- p1 + p3 + gridExtra::tableGrob(table_filter_case[1:3, c("desc", "value")],
    theme = ttheme_minimal(core = list(fg_params = list(
        col = cols_case,
        hjust = 0,
        x = 0.0,
        fontsize = 18
    ))),
    rows = NULL,
    cols = NULL
) +
    p2 + p4 + gridExtra::tableGrob(table_filter_death[1:3, c("desc", "value")],
        theme = ttheme_minimal(core = list(fg_params = list(
            col = cols_death,
            hjust = 0,
            x = 0.0,
            fontsize = 18
        ))),
        rows = NULL,
        cols = NULL
    ) +
    plot_layout(widths = c(2, 1, 1), ncol = 3)
   print(output)
   cat('\n') 
}
```

## Daily cases by Jurisdiction (7-day moving average)

```{r PT C, code=xfun::read_utf8('src/03_pt_slides.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

## COVID-19 patients in hospital daily across Canada 

```{r Can HI, code=c(Sys.setenv(hosp_prname="Canada"), xfun::read_utf8('src/05_hosp_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

## COVID-19 patients in hospital daily in selected provinces and territories 

```{r PT HI, code=c(Sys.setenv(hosp_prname="pts"), xfun::read_utf8('src/05_hosp_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

## COVID-19 patients in hospital daily in selected provinces and territories 

Indicators derived from the Case Report Forms

## COVID-19 cases by age, Canada
```{r Canada Age C, code=c(Sys.setenv(age_prname="Canada"), xfun::read_utf8('src/04_age_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

## COVID-19 cases by age, select provinces and territories
```{r PT Age C, code=c(Sys.setenv(age_prname="pts"), xfun::read_utf8('src/04_age_slides.R')), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

## Estimate for case detection: Onset to lab collection (days)
```{r Lab Onset, code=xfun::read_utf8('src/08_lab_onset.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```

## Daily Cases by Country (7-day moving average, population adjusted)

```{r Int C, code=xfun::read_utf8('src/02_int_slides.R'), results = "hide", message=FALSE, warning=FALSE, fig.height = 9, fig.width = 20}
```
